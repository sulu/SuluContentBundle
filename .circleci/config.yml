# PHP CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-php/ for more details
#
version: 2

.environment_variables: &environment_variables
    APP_ENV: test
    DATABASE_URL: mysql://root:root@127.0.0.1:3306/su_content_test
    DATABASE_CHARSET: utf8mb4
    DATABASE_COLLATE: utf8mb4_unicode_ci

.enable_pcov: &enable_pcov
    name: Enable PCOV, disable Xdebug
    command: |
        pecl install pcov
        docker-php-ext-enable pcov
        rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini || true

workflows:
    version: 2
    default:
        jobs:
            - composer
            - lint:
                  requires:
                      - composer
            - test:
                  requires:
                      - composer
            - test-coverage:
                  requires:
                      - composer
                      - test

jobs:
    composer:
        docker:
            - image: composer:latest
        steps:
            - checkout
            - run: composer config -g cache-dir "$(pwd)/.composer-cache"
            - restore_cache:
                  keys:
                      - v8-composer-cache-{{ checksum "composer.json" }}
                      - v8-composer-cache-
            - run: composer install -n --prefer-dist --ignore-platform-reqs --no-scripts
            - run: composer phpunit -- install
            - run: curl --show-error --silent https://getcomposer.org/installer | php
            - save_cache:
                  paths:
                      - .composer-cache
                  key: v8-composer-cache-{{ checksum "composer.json" }}
            - persist_to_workspace:
                  root: .
                  paths:
                      - vendor
                      - composer.phar
                      - composer.lock
    lint:
        docker:
            - image: sulu/php:7.2-cli
            - image: mysql:5.7
              environment:
                  MYSQL_ROOT_PASSWORD: root
        environment: *environment_variables
        steps:
            - run: echo "waiting for mysql container startup" && sleep 5
            - checkout
            - attach_workspace:
                  at: .
            - run: php composer.phar info
            - run: ls vendor/symfony/framework-bundle/
            - run: php composer.phar bootstrap-test-environment
            - run: php composer.phar lint
    test:
        docker:
            - image: sulu/php:7.2-cli
            - image: mysql:5.7
              environment:
                  MYSQL_ROOT_PASSWORD: root
        environment: *environment_variables
        steps:
            - run: echo "waiting for mysql container startup" && sleep 5
            - checkout
            - attach_workspace:
                  at: .
            - run: *enable_pcov
            - run: php -m
            - run: php composer.phar bootstrap-test-environment
            - run: php composer.phar test-coverage
            - store_artifacts:
                  path: Tests/reports/html
            - store_test_results:
                  path: Tests/reports
            - persist_to_workspace:
                  root: .
                  paths:
                      - Tests/reports

    test-coverage:
        docker:
            - image: sulu/php:7.2-cli
        environment: *environment_variables
        steps:
            - checkout
            - attach_workspace:
                  at: .
            - run: *enable_pcov
            - run: php composer.phar test-coverage-checker -- --coverage-clover Tests/reports/clover.xml
            - run: wget https://github.com/php-coveralls/php-coveralls/releases/download/v2.1.0/php-coveralls.phar
            - run: chmod +x php-coveralls.phar
            - run: php php-coveralls.phar --coverage_clover Tests/reports/clover.xml --json_path Tests/reports/coveralls.json
